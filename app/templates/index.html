<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" href="{{ icon }}" type="image/x-icon">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#007bff',
                    }
                }
            }
        }
    </script>
    <style>
        .dataTables_wrapper .dataTables_paginate .paginate_button {
            padding: 0.3em 0.8em;
            margin: 0 0.2em;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button.current {
            background: #007bff !important;
            color: white !important;
            border: none;
        }
        .dataTables_wrapper .dataTables_paginate .paginate_button:hover {
            background: #0056b3 !important;
            color: white !important;
        }
    </style>
</head>
<body class="flex flex-col min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 transition-colors duration-200">
    <nav class="bg-white dark:bg-gray-800 shadow-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="#" class="flex items-center space-x-2 text-xl font-semibold">
                <img src="{{ icon }}" alt="PlexSpot Icon" class="w-8 h-8">
                <span>{{ title }}</span>
            </a>
        </div>
    </nav>

    <div class="flex-grow p-4">
        <div class="grid md:grid-cols-2 gap-4 mb-4">
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 transition-transform duration-300 hover:-translate-y-1">
                <h5 class="text-lg font-semibold text-primary mb-2"><i class="fas fa-play-circle mr-2"></i>Active Streams</h5>
                <p class="text-3xl font-bold" id="activeStreams">Loading...</p>
            </div>
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4 transition-transform duration-300 hover:-translate-y-1">
                <h5 class="text-lg font-semibold text-primary mb-2"><i class="fas fa-film mr-2"></i>Library Total</h5>
                <p class="text-3xl font-bold" id="libraryTotal">Loading...</p>
            </div>
        </div>

        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-4">
            <select id="librarySelect" class="w-full mb-4 p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                <option value="">Select a Library</option>
            </select>
            <div class="grid md:grid-cols-3 gap-4 mb-4">
                <select id="libraryContents_length" class="p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <option value="25">Show 25 entries</option>
                    <option value="50">Show 50 entries</option>
                    <option value="100">Show 100 entries</option>
                    <option value="-1">Show All</option>
                </select>
                <select id="genreFilter" class="p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100">
                    <option value="">All Genres</option>
                </select>
                <input type="search" class="p-2 rounded border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100" placeholder="Search" aria-controls="libraryContents">
            </div>
            <div class="overflow-x-auto">
                <table id="libraryContents" class="w-full text-left border-collapse">
                    <thead>
                        <tr class="bg-gray-200 dark:bg-gray-700">
                            <th class="p-3">Title</th>
                            <th class="p-3">Year</th>
                            <th class="p-3">Genres</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <footer class="bg-white dark:bg-gray-800 shadow-md mt-auto">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <a href="https://github.com/ziadhorat/plex-spot" target="_blank" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                <i class="fab fa-github mr-2"></i>Github: Plex-spot
            </a>
            <button id="darkModeToggle" class="text-gray-600 dark:text-gray-400 hover:text-gray-800 dark:hover:text-gray-200">
                <i class="fas fa-moon mr-2"></i>Dark Mode
            </button>
        </div>
    </footer>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
    <script>
        $(document).ready(function() {
            let table;
            let defaultLibrary = "{{ default_library|default('', true) }}";
            let isDarkMode = localStorage.getItem('darkMode') === 'true';

            function toggleDarkMode() {
                isDarkMode = !isDarkMode;
                document.documentElement.classList.toggle('dark', isDarkMode);
                $('#darkModeToggle').html(isDarkMode ? '<i class="fas fa-sun mr-2"></i>Light Mode' : '<i class="fas fa-moon mr-2"></i>Dark Mode');
                localStorage.setItem('darkMode', isDarkMode);
            }

            $('#darkModeToggle').click(toggleDarkMode);

            if (isDarkMode) {
                document.documentElement.classList.add('dark');
                $('#darkModeToggle').html('<i class="fas fa-sun mr-2"></i>Light Mode');
            }

            function updateUserStats() {
                $.get('/api/user_stats', function(data) {
                    $('#activeStreams').text(data.active_sessions);
                });
            }

            function loadLibraries() {
                $.get('/api/libraries', function(data) {
                    $('#librarySelect').empty().append('<option value="">Select a Library</option>');
                    data.forEach(function(library) {
                        $('#librarySelect').append(`<option value="${library.key}">${library.title}</option>`);
                    });
                    if (defaultLibrary) {
                        $('#librarySelect').val(defaultLibrary);
                        loadLibraryContents(defaultLibrary);
                    } else if (data.length > 0) {
                        defaultLibrary = data[0].key;
                        $('#librarySelect').val(defaultLibrary);
                        loadLibraryContents(defaultLibrary);
                    } else {
                        $('#libraryContents tbody').html('<tr><td colspan="3" class="p-3">No libraries available</td></tr>');
                    }
                });
            }

            function loadGenres(libraryKey) {
                $.get(`/api/genres/${libraryKey}`, function(genres) {
                    $('#genreFilter').empty().append('<option value="">All Genres</option>');
                    genres.forEach(function(genre) {
                        $('#genreFilter').append(`<option value="${genre}">${genre}</option>`);
                    });
                });
            }

            function loadLibraryContents(libraryKey) {
                $.get(`/api/library_contents/${libraryKey}`, function(data) {
                    if (table) {
                        table.destroy();
                    }
                    $('#libraryContents tbody').empty();
                    data.forEach(function(item) {
                        $('#libraryContents tbody').append(`
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="p-3">${item.title}</td>
                                <td class="p-3">${item.year}</td>
                                <td class="p-3">${item.genres}</td>
                            </tr>
                        `);
                    });
                    table = $('#libraryContents').DataTable({
                        "pageLength": 25,
                        "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                        "dom": '<"my-4"t><"flex flex-col md:flex-row justify-between items-center"<"text-gray-600 dark:text-gray-400"i><"mt-4 md:mt-0"p>>',
                        "language": {
                            "lengthMenu": "_MENU_"
                        },
                        "drawCallback": function() {
                            $('.paginate_button').addClass('px-3 py-1 bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 rounded hover:bg-gray-300 dark:hover:bg-gray-600');
                            $('.paginate_button.current').addClass('bg-primary text-white');
                        },
                        "paging": true,
                        "ordering": true,
                        "info": true,
                        "searching": true,
                        "responsive": true
                    });
                    $('#libraryTotal').text(data.length);
                    loadGenres(libraryKey);
                    
                    $('#libraryContents_length').on('change', function() {
                        table.page.len($(this).val()).draw();
                    });
                    $('input[type="search"]').on('keyup', function() {
                        table.search(this.value).draw();
                    });
                    $('#genreFilter').on('change', function() {
                        table.column(2).search(this.value).draw();
                    });
                });
            }

            $('#librarySelect').change(function() {
                let selectedLibrary = $(this).val();
                if (selectedLibrary) {
                    loadLibraryContents(selectedLibrary);
                }
            });

            updateUserStats();
            loadLibraries();
            setInterval(updateUserStats, 60000);
        });
    </script>
</body>
</html>