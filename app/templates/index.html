<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="icon" href="{{ icon }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/1.10.25/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        body {
            transition: background-color 0.3s, color 0.3s;
            padding-bottom: 60px;
        }
        .content-wrapper {
            min-height: calc(100vh - 60px);
            padding: 0 15px;  /* Add padding to the content wrapper */
        }
        footer {
            height: 60px;
            transition: background-color 0.3s, color 0.3s;
            background-color: #f8f9fa;  /* Light mode background */
        }
        body.dark-mode {
            background-color: #121212;
            color: #ffffff;
        }
        .dark-mode .card, 
        .dark-mode .form-select, 
        .dark-mode .form-control,
        .dark-mode .table,
        .dark-mode footer {
            background-color: #1e1e1e;
            color: #ffffff;
            border-color: #444;
        }
        .dark-mode .table tbody tr {
            background-color: #1e1e1e !important;
        }
        .dark-mode .page-item:not(.active) .page-link {
            background-color: #2c2c2c;
            border-color: #444;
            color: #ffffff;
        }
        .dark-mode .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
        #controls-row {
            margin-bottom: 1rem;
        }
        #controls-row > div {
            padding: 0 5px;
        }
        #controls-row select, #controls-row input {
            width: 100%;
        }
        /* Ensure consistent padding for all elements */
        .card, #librarySelect, #controls-row, #libraryContents {
            margin-bottom: 1rem;
        }
        /* New styles */
        .controls-wrapper {
            padding: 0 15px;
            margin-bottom: 1rem;
        }
        
        .dataTables_wrapper .row {
            margin: 0;
            align-items: center;
        }
        
        .dataTables_info, .dataTables_paginate {
            padding: 0 15px;
        }
        
        .dataTables_paginate {
            display: flex;
            justify-content: flex-end;
        }
    </style>
</head>
<body class="dark-mode">
    <div class="content-wrapper container-fluid py-3">
        <h1 class="mb-4">
            <img src="{{ icon }}" alt="PlexSpot Icon" style="width: 30px; margin-right: 10px;">
            {{ title }}
        </h1>
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Active Streams</h5>
                        <p class="card-text" id="activeStreams">Loading...</p>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Library Total</h5>
                        <p class="card-text" id="libraryTotal">Loading...</p>
                    </div>
                </div>
            </div>
        </div>
        <div class="mb-4">
            <select id="librarySelect" class="form-select">
                <option value="">Select a Library</option>
            </select>
        </div>
        <div id="controls-row" class="row controls-wrapper">
            <div class="col-md-3">
                <select id="libraryContents_length" class="form-select form-select-sm">
                    <option value="25">Show 25 entries</option>
                    <option value="50">Show 50 entries</option>
                    <option value="100">Show 100 entries</option>
                    <option value="-1">Show All</option>
                </select>
            </div>
            <div class="col-md-3">
                <select id="genreFilter" class="form-select form-select-sm">
                    <option value="">All Genres</option>
                </select>
            </div>
            <div class="col-md-6">
                <input type="search" class="form-control form-control-sm" placeholder="Search" aria-controls="libraryContents">
            </div>
        </div>
        <table id="libraryContents" class="table">
            <thead>
                <tr>
                    <th>Title</th>
                    <th>Year</th>
                    <th>Genres</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        </table>
    </div>
    <footer class="fixed-bottom py-2">
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-6">
                    <a href="https://github.com/ziadhorat/plex-spot" target="_blank" class="text-muted">Github: Plex-spot</a>
                </div>
                <div class="col-6 text-end">
                    <span id="darkModeToggle" style="cursor: pointer;">Light Mode</span>
                </div>
            </div>
        </div>
    </footer>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.25/js/dataTables.bootstrap5.min.js"></script>
    <script>
        $(document).ready(function() {
            let table;
            let defaultLibrary = "{{ default_library|default('', true) }}";
            let isDarkMode = true;

            function toggleDarkMode() {
                isDarkMode = !isDarkMode;
                $('body').toggleClass('dark-mode', isDarkMode);
                $('#darkModeToggle').text(isDarkMode ? 'Light Mode' : 'Dark Mode');
                localStorage.setItem('darkMode', isDarkMode);
            }

            $('#darkModeToggle').click(toggleDarkMode);

            // Check localStorage for dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode !== null) {
                isDarkMode = savedDarkMode === 'true';
                $('body').toggleClass('dark-mode', isDarkMode);
                $('#darkModeToggle').text(isDarkMode ? 'Light Mode' : 'Dark Mode');
            }

            function updateUserStats() {
                $.get('/api/user_stats', function(data) {
                    $('#activeStreams').text(data.active_sessions);
                });
            }

            function loadLibraries() {
                $.get('/api/libraries', function(data) {
                    $('#librarySelect').empty().append('<option value="">Select a Library</option>');
                    data.forEach(function(library) {
                        $('#librarySelect').append(`<option value="${library.key}">${library.title}</option>`);
                    });
                    if (defaultLibrary) {
                        $('#librarySelect').val(defaultLibrary);
                        loadLibraryContents(defaultLibrary);
                    } else if (data.length > 0) {
                        defaultLibrary = data[0].key;
                        $('#librarySelect').val(defaultLibrary);
                        loadLibraryContents(defaultLibrary);
                    } else {
                        $('#libraryContents tbody').html('<tr><td colspan="3">No libraries available</td></tr>');
                    }
                });
            }

            function loadGenres(libraryKey) {
                $.get(`/api/genres/${libraryKey}`, function(genres) {
                    $('#genreFilter').empty().append('<option value="">All Genres</option>');
                    genres.forEach(function(genre) {
                        $('#genreFilter').append(`<option value="${genre}">${genre}</option>`);
                    });
                });
            }

            function loadLibraryContents(libraryKey) {
                $.get(`/api/library_contents/${libraryKey}`, function(data) {
                    if (table) {
                        table.destroy();
                    }
                    $('#libraryContents tbody').empty();
                    data.forEach(function(item) {
                        $('#libraryContents tbody').append(`
                            <tr>
                                <td>${item.title}</td>
                                <td>${item.year}</td>
                                <td>${item.genres}</td>
                            </tr>
                        `);
                    });
                    table = $('#libraryContents').DataTable({
                        "pageLength": 25,
                        "lengthMenu": [[25, 50, 100, -1], [25, 50, 100, "All"]],
                        "dom": '<"row"<"col-sm-12"t>><"row"<"col-sm-12 col-md-5"i><"col-sm-12 col-md-7"p>>',
                        "language": {
                            "lengthMenu": "_MENU_"
                        },
                        "width": "100%"
                    });
                    $('#libraryTotal').text(data.length);
                    loadGenres(libraryKey);
                    
                    // Connect custom controls to DataTable
                    $('#libraryContents_length').on('change', function() {
                        table.page.len($(this).val()).draw();
                    });
                    $('#controls-row input[type="search"]').on('keyup', function() {
                        table.search(this.value).draw();
                    });
                    $('#genreFilter').on('change', function() {
                        table.column(2).search(this.value).draw();
                    });
                });
            }

            $('#librarySelect').change(function() {
                let selectedLibrary = $(this).val();
                if (selectedLibrary) {
                    loadLibraryContents(selectedLibrary);
                }
            });

            updateUserStats();
            loadLibraries();
            setInterval(updateUserStats, 60000);  // Update every minute
        });
    </script>
</body>
</html>